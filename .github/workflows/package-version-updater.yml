---
name: Package version updater
"on": push
# schedule:
#   - cron: "42 2 * * 1-5"
permissions:
  contents: write
  pull-requests: write
jobs:
  update-package-version-not-updated-by-dependabot:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5.0.0
      - name: latest stable release vektra mockery
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_VERSION_UPDATER_BRANCH: package-version-updater
          BUILD_TASKFILE: build/task.yml
        run: |
          latest_stable_package_version_on_github() {
            gh release list \
              --repo $1 \
              --limit 100 \
              --json tagName,isDraft,isPrerelease,publishedAt | \
                jq -r '[.[] | select(.isDraft == false and .isPrerelease == false)] | sort_by(.publishedAt) | last.tagName'
          }

          export GO_SWAGGER_VERSION=$(latest_stable_package_version_on_github \
            go-swagger/go-swagger)
          echo "GO_SWAGGER_VERSION: ${GO_SWAGGER_VERSION}"
          export GQLGEN_VERSION=$(latest_stable_package_version_on_github \
            99designs/gqlgen)
          echo "GQLGEN_VERSION: ${GQLGEN_VERSION}"
          export GQLGENC_VERSION=$(latest_stable_package_version_on_github \
            Yamashou/gqlgenc)
          echo "GQLGENC_VERSION: ${GQLGENC_VERSION}"
          export GRAPHQL_LINTER_VERSION=$(latest_stable_package_version_on_github \
            schubergphilis/graphql-linter)
          echo "GRAPHQL_LINTER_VERSION: ${GRAPHQL_LINTER_VERSION}"
          export MOCKERY_VERSION=$(latest_stable_package_version_on_github \
            vektra/mockery)
          echo "MOCKERY_VERSION: ${MOCKERY_VERSION}"
          export OPA_VERSION=$(latest_stable_package_version_on_github \
            open-policy-agent/opa)
          echo "OPA_VERSION: ${OPA_VERSION}"
          export PRESENT_VERSION=$(go list -m -versions golang.org/x/tools | \
            tr ' ' '\n' | \
            grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | \
            tail -1
          )
          echo "PRESENT_VERSION: ${PRESENT_VERSION}"
          export REGAL_VERSION=$(latest_stable_package_version_on_github \
            StyraOSS/regal)
          echo "REGAL_VERSION: ${REGAL_VERSION}"
          export YQ_VERSION=$(latest_stable_package_version_on_github \
            mikefarah/yq)

          echo "YQ_VERSION: ${YQ_VERSION}"
          yq -i '.vars.YQ_VERSION = strenv(YQ_VERSION)' ${BUILD_TASKFILE}

          git fetch -p -P
          if (git ls-remote --exit-code --heads origin refs/heads/${PACKAGE_VERSION_UPDATER_BRANCH}); then
            echo "Branch '${PACKAGE_VERSION_UPDATER_BRANCH}' already exists."
            git checkout ${PACKAGE_VERSION_UPDATER_BRANCH}
          else
            git checkout -b ${PACKAGE_VERSION_UPDATER_BRANCH}
          fi
          if [ -n "$(git status --porcelain)" ]; then echo "There are uncommitted changes."; else echo "No changes to commit." && exit 0; fi
          git add ${BUILD_TASKFILE}
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          if ! git commit -m "build(deps): weekly update package versions that cannot be updated by dependabot"; then git commit --amend --no-edit; fi
          git push origin ${PACKAGE_VERSION_UPDATER_BRANCH}
